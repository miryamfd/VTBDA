{% extends "base.html" %}

{% block title %}Rapports - {{ super() }}{% endblock %}

{% block content %}
<div class="reports-page">
    <h2>Rapports d'Analyse</h2>

    <!-- Boutons d'action -->
    <div class="action-buttons" style="margin-bottom: 2rem;">
        <a href="/generate_pdf" class="btn btn-primary" target="_blank">
            Générer Rapport PDF
        </a>
        <button onclick="refreshCharts()" class="btn btn-secondary">
            Actualiser les Graphiques
        </button>
    </div>

    <section class="report-section">
        <h3>Résumé Global</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <p>Total de vulnérabilités</p>
                <p class="stat-number">{{ stats.total_vulnerabilities }}</p>
            </div>
            <div class="stat-card critical">
                <p>Critiques</p>
                <p class="stat-number">{{ stats.critical }}</p>
            </div>
            <div class="stat-card high">
                <p>Haute sévérité</p>
                <p class="stat-number">{{ stats.high }}</p>
            </div>
        </div>
    </section>

    <!-- Graphiques Chart.js Interactifs -->
    <section class="report-section">
        <h3>Graphiques Interactifs</h3>
        <div class="charts-grid">
            <div class="chart-container">
                <h4>Distribution par Sévérité</h4>
                <canvas id="severityChart" width="400" height="300"></canvas>
            </div>
            <div class="chart-container">
                <h4>Évolution Temporelle (30 jours)</h4>
                <canvas id="temporalChart" width="400" height="300"></canvas>
            </div>
            <div class="chart-container">
                <h4>Top Composants Affectés</h4>
                <canvas id="componentsChart" width="400" height="300"></canvas>
            </div>
            <div class="chart-container">
                <h4>Répartition par Écosystème</h4>
                <canvas id="ecosystemChart" width="400" height="300"></canvas>
            </div>
        </div>
    </section>

    <!-- Graphiques Matplotlib Statiques -->
    {% if charts %}
    <section class="report-section">
        <h3>Graphiques Détaillés (Matplotlib)</h3>
        <div class="charts-grid">
            {% if charts.severity_distribution %}
            <div class="chart-container">
                <h4>Distribution par Sévérité - Vue Détaillée</h4>
                <img src="data:image/png;base64,{{ charts.severity_distribution }}" alt="Distribution par sévérité" style="max-width: 100%; height: auto;">
            </div>
            {% endif %}

            {% if charts.temporal_evolution %}
            <div class="chart-container">
                <h4>Évolution Temporelle - Vue Détaillée</h4>
                <img src="data:image/png;base64,{{ charts.temporal_evolution }}" alt="Évolution temporelle" style="max-width: 100%; height: auto;">
            </div>
            {% endif %}

            {% if charts.top_components %}
            <div class="chart-container">
                <h4>Top Composants - Vue Détaillée</h4>
                <img src="data:image/png;base64,{{ charts.top_components }}" alt="Top composants" style="max-width: 100%; height: auto;">
            </div>
            {% endif %}
        </div>
    </section>
    {% endif %}

    <!-- Analyse Avancée -->
    <section class="report-section">
        <h3>Analyse Avancée</h3>

        {% if text_analysis %}
        <div class="analysis-section">
            <h4>Analyse Textuelle</h4>
            <p><strong>Taille du vocabulaire:</strong> {{ text_analysis.vocabulary_size }} termes</p>
            <p><strong>Termes les plus fréquents:</strong> {{ text_analysis.top_terms|join(', ') }}</p>
            <p><strong>Dimensions des vecteurs:</strong> {{ text_analysis.vectors_shape[0] }} documents × {{ text_analysis.vectors_shape[1] }} termes</p>
        </div>
        {% endif %}

        {% if summaries %}
        <div class="analysis-section">
            <h4>Résumés Automatiques (NLTK)</h4>
            <div class="summaries-list">
                {% for summary in summaries[:5] %}
                <div class="summary-item">
                    <h5>{{ summary.cve_id }}</h5>
                    <p><small>Longueur originale: {{ summary.original_length }} caractères</small></p>
                    <p>{{ summary.summary }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </section>

    <!-- Tableaux détaillés -->
    <section class="report-section">
        <h3>Données Détaillées</h3>

        <div class="data-tables">
            <div class="table-container">
                <h4>Distribution par Sévérité</h4>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Sévérité</th>
                            <th>Nombre</th>
                            <th>Pourcentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for severity, data in severity_breakdown.items() %}
                        <tr>
                            <td><span class="severity-badge {{ severity|lower }}">{{ severity }}</span></td>
                            <td>{{ data.count }}</td>
                            <td>{{ data.percentage }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="table-container">
                <h4>Tendances (30 derniers jours)</h4>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Composant</th>
                            <th>Mentions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for component, count in trends.items() %}
                        <tr>
                            <td>{{ component }}</td>
                            <td>{{ count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<!-- JavaScript pour les graphiques Chart.js -->
<script>
// Données pour les graphiques (passées depuis Flask)
const severityData = {{ severity_breakdown|tojson }};
const trendsData = {{ trends|tojson }};
const statsData = {{ stats|tojson }};

// Configuration des couleurs
const severityColors = {
    'CRITICAL': '#e74c3c',
    'HIGH': '#f39c12',
    'MEDIUM': '#3498db',
    'LOW': '#2ecc71',
    'NONE': '#95a5a6'
};

// Graphique de distribution par sévérité
function createSeverityChart() {
    const ctx = document.getElementById('severityChart').getContext('2d');
    const labels = Object.keys(severityData);
    const data = Object.values(severityData).map(item => item.count);
    const colors = labels.map(label => severityColors[label] || '#95a5a6');

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Graphique d'évolution temporelle
function createTemporalChart() {
    const ctx = document.getElementById('temporalChart').getContext('2d');

    // Données simulées pour la démo (à remplacer par de vraies données temporelles)
    const dates = [];
    const counts = [];
    const now = new Date();

    for (let i = 29; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        dates.push(date.toLocaleDateString('fr-FR'));
        counts.push(Math.floor(Math.random() * 10) + 1);
    }

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Vulnérabilités découvertes',
                data: counts,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: true
                }
            }
        }
    });
}

// Graphique des composants
function createComponentsChart() {
    const ctx = document.getElementById('componentsChart').getContext('2d');
    const labels = Object.keys(trendsData);
    const data = Object.values(trendsData);

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Nombre de mentions',
                data: data,
                backgroundColor: 'rgba(52, 152, 219, 0.8)',
                borderColor: '#3498db',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// Graphique des écosystèmes
function createEcosystemChart() {
    const ctx = document.getElementById('ecosystemChart').getContext('2d');

    // Données d'exemple (à remplacer par de vraies données)
    const ecosystems = ['npm', 'pip', 'maven', 'docker', 'kubernetes', 'github'];
    const data = ecosystems.map(() => Math.floor(Math.random() * 20) + 5);

    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ecosystems,
            datasets: [{
                label: 'Vulnérabilités par écosystème',
                data: data,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.2)',
                pointBackgroundColor: '#e74c3c',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#e74c3c'
            }]
        },
        options: {
            responsive: true,
            scales: {
                r: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Fonction pour rafraîchir les graphiques
function refreshCharts() {
    // Recréer tous les graphiques
    createSeverityChart();
    createTemporalChart();
    createComponentsChart();
    createEcosystemChart();

    // Afficher un message de confirmation
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '✅ Actualisé !';
    setTimeout(() => {
        btn.innerHTML = originalText;
    }, 2000);
}

// Initialiser les graphiques au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    createSeverityChart();
    createTemporalChart();
    createComponentsChart();
    createEcosystemChart();
});
</script>

<style>
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 2rem;
    margin: 2rem 0;
}

.chart-container {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.chart-container h4 {
    margin-bottom: 1rem;
    color: #2c3e50;
    text-align: center;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.btn-secondary {
    background-color: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background-color: #7f8c8d;
}

.analysis-section {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    margin: 1rem 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.summaries-list {
    max-height: 400px;
    overflow-y: auto;
}

.summary-item {
    border-bottom: 1px solid #eee;
    padding: 1rem 0;
}

.summary-item:last-child {
    border-bottom: none;
}

.summary-item h5 {
    color: #e74c3c;
    margin-bottom: 0.5rem;
}

.data-tables {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
}

.table-container {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.table-container h4 {
    margin-bottom: 1rem;
    color: #2c3e50;
}

@media (max-width: 768px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }

    .data-tables {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
